# Nexus Backend Makefile
# ë¡œì»¬ ê°œë°œ ë° ë°°í¬ ìë™í™”

# ë³€ìˆ˜ ì„¤ì •
PYTHON := python3
PIP := pip3
VENV := venv
STAGE ?= dev
REGION ?= us-east-1
SERVICE_NAME ?= nexus-backend

# ìƒ‰ìƒ ì¶œë ¥
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: help
help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "$(BLUE)Nexus Backend ëª…ë ¹ì–´$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

.PHONY: setup
setup: ## ì´ˆê¸° ê°œë°œ í™˜ê²½ ì„¤ì •
	@echo "$(YELLOW)ğŸ”§ ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘...$(NC)"
	$(PYTHON) -m venv $(VENV)
	. $(VENV)/bin/activate && $(PIP) install --upgrade pip
	. $(VENV)/bin/activate && $(PIP) install -r requirements-dev.txt
	@echo "$(GREEN)âœ… ì„¤ì • ì™„ë£Œ! 'source venv/bin/activate'ë¡œ ê°€ìƒí™˜ê²½ í™œì„±í™”$(NC)"

.PHONY: install
install: ## í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "$(YELLOW)ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && $(PIP) install -r requirements.txt
	@echo "$(GREEN)âœ… ì„¤ì¹˜ ì™„ë£Œ$(NC)"

.PHONY: install-dev
install-dev: ## ê°œë°œ ì˜ì¡´ì„± ì„¤ì¹˜
	@echo "$(YELLOW)ğŸ“¦ ê°œë°œ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && $(PIP) install -r requirements-dev.txt
	@echo "$(GREEN)âœ… ì„¤ì¹˜ ì™„ë£Œ$(NC)"

.PHONY: clean
clean: ## ìºì‹œ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
	@echo "$(YELLOW)ğŸ§¹ ì •ë¦¬ ì¤‘...$(NC)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ… ì •ë¦¬ ì™„ë£Œ$(NC)"

.PHONY: format
format: ## ì½”ë“œ í¬ë§·íŒ… (black, isort)
	@echo "$(YELLOW)âœ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘...$(NC)"
	. $(VENV)/bin/activate && black . --exclude venv
	. $(VENV)/bin/activate && isort . --skip venv
	@echo "$(GREEN)âœ… í¬ë§·íŒ… ì™„ë£Œ$(NC)"

.PHONY: lint
lint: ## ì½”ë“œ ë¦°íŒ… (flake8, pylint)
	@echo "$(YELLOW)ğŸ” ì½”ë“œ ê²€ì‚¬ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && flake8 . --exclude=venv,tests --max-line-length=120
	. $(VENV)/bin/activate && pylint handlers services utils config --ignore=venv,tests || true
	@echo "$(GREEN)âœ… ë¦°íŒ… ì™„ë£Œ$(NC)"

.PHONY: type-check
type-check: ## íƒ€ì… ì²´í¬ (mypy)
	@echo "$(YELLOW)ğŸ” íƒ€ì… ê²€ì‚¬ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && mypy . --ignore-missing-imports --exclude venv
	@echo "$(GREEN)âœ… íƒ€ì… ì²´í¬ ì™„ë£Œ$(NC)"

.PHONY: test
test: ## í…ŒìŠ¤íŠ¸ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && pytest tests/ -v --cov=. --cov-report=term-missing
	@echo "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

.PHONY: test-unit
test-unit: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && pytest tests/unit/ -v
	@echo "$(GREEN)âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

.PHONY: test-integration
test-integration: ## í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
	@echo "$(YELLOW)ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && pytest tests/integration/ -v
	@echo "$(GREEN)âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

.PHONY: validate
validate: clean format lint type-check test ## ì „ì²´ ê²€ì¦ (í¬ë§·, ë¦°íŠ¸, íƒ€ì…, í…ŒìŠ¤íŠ¸)
	@echo "$(GREEN)âœ… ëª¨ë“  ê²€ì¦ ì™„ë£Œ!$(NC)"

.PHONY: config-check
config-check: ## í˜„ì¬ ì„¤ì • í™•ì¸
	@echo "$(BLUE)ğŸ“‹ í˜„ì¬ ì„¤ì •:$(NC)"
	@echo "  STAGE: $(STAGE)"
	@echo "  REGION: $(REGION)"
	@echo "  SERVICE_NAME: $(SERVICE_NAME)"
	@. $(VENV)/bin/activate && python -c "from config.settings import settings; print(f'  TABLE_PREFIX: {settings.TABLE_PREFIX}'); print(f'  TABLE_SUFFIX: {settings.TABLE_SUFFIX}')"

.PHONY: local-api
local-api: ## ë¡œì»¬ API ì„œë²„ ì‹¤í–‰ (ê°œë°œìš©)
	@echo "$(YELLOW)ğŸš€ ë¡œì»¬ API ì„œë²„ ì‹œì‘...$(NC)"
	@echo "$(BLUE)API: http://localhost:3000$(NC)"
	. $(VENV)/bin/activate && ENVIRONMENT=dev LOG_LEVEL=DEBUG python -m pytest tests/fixtures/local_server.py

.PHONY: deploy-dev
deploy-dev: validate ## ê°œë°œ í™˜ê²½ ë°°í¬
	@echo "$(YELLOW)ğŸš€ ê°œë°œ í™˜ê²½ ë°°í¬ ì¤‘...$(NC)"
	@echo "$(BLUE)í™˜ê²½: dev, ë¦¬ì „: $(REGION)$(NC)"
	npx serverless deploy --stage dev --region $(REGION)
	@echo "$(GREEN)âœ… ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ$(NC)"

.PHONY: deploy-staging
deploy-staging: validate ## ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
	@echo "$(YELLOW)ğŸš€ ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬ ì¤‘...$(NC)"
	@echo "$(BLUE)í™˜ê²½: staging, ë¦¬ì „: $(REGION)$(NC)"
	@read -p "ìŠ¤í…Œì´ì§• ë°°í¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm && [ "$$confirm" = "y" ]
	npx serverless deploy --stage staging --region $(REGION)
	@echo "$(GREEN)âœ… ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬ ì™„ë£Œ$(NC)"

.PHONY: deploy-prod
deploy-prod: ## í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ (ì£¼ì˜!)
	@echo "$(RED)âš ï¸  í”„ë¡œë•ì…˜ ë°°í¬ - ì£¼ì˜ í•„ìš”!$(NC)"
	@echo "$(BLUE)í™˜ê²½: prod, ë¦¬ì „: ap-northeast-2$(NC)"
	@read -p "ì •ë§ë¡œ í”„ë¡œë•ì…˜ì— ë°°í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? 'production'ì„ ì…ë ¥í•˜ì„¸ìš”: " confirm && [ "$$confirm" = "production" ]
	npx serverless deploy --stage prod --region ap-northeast-2
	@echo "$(GREEN)âœ… í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ ì™„ë£Œ$(NC)"

.PHONY: remove
remove: ## ë°°í¬ëœ ìŠ¤íƒ ì œê±°
	@echo "$(RED)âš ï¸  ìŠ¤íƒ ì œê±°: $(STAGE)$(NC)"
	@read -p "$(STAGE) ìŠ¤íƒì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm && [ "$$confirm" = "y" ]
	npx serverless remove --stage $(STAGE) --region $(REGION)
	@echo "$(GREEN)âœ… ìŠ¤íƒ ì œê±° ì™„ë£Œ$(NC)"

.PHONY: logs
logs: ## CloudWatch ë¡œê·¸ í™•ì¸
	@echo "$(BLUE)ğŸ“‹ CloudWatch ë¡œê·¸ ($(STAGE))$(NC)"
	npx serverless logs --function conversationApi --stage $(STAGE) --region $(REGION) --tail

.PHONY: logs-all
logs-all: ## ëª¨ë“  í•¨ìˆ˜ì˜ ë¡œê·¸ í™•ì¸
	@echo "$(BLUE)ğŸ“‹ ëª¨ë“  í•¨ìˆ˜ ë¡œê·¸ ($(STAGE))$(NC)"
	npx serverless logs --stage $(STAGE) --region $(REGION) --tail

.PHONY: invoke
invoke: ## Lambda í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ (í…ŒìŠ¤íŠ¸)
	@echo "$(YELLOW)âš¡ Lambda í•¨ìˆ˜ í˜¸ì¶œ ì¤‘...$(NC)"
	npx serverless invoke --function conversationApi --stage $(STAGE) --region $(REGION) --path tests/fixtures/sample_event.json

.PHONY: package
package: ## ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (ë°°í¬ ì—†ì´)
	@echo "$(YELLOW)ğŸ“¦ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì¤‘...$(NC)"
	npx serverless package --stage $(STAGE) --region $(REGION)
	@echo "$(GREEN)âœ… íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ (.serverless/ í´ë” í™•ì¸)$(NC)"

.PHONY: info
info: ## ë°°í¬ëœ ì„œë¹„ìŠ¤ ì •ë³´ í™•ì¸
	@echo "$(BLUE)â„¹ï¸  ì„œë¹„ìŠ¤ ì •ë³´ ($(STAGE))$(NC)"
	npx serverless info --stage $(STAGE) --region $(REGION) --verbose

.PHONY: metrics
metrics: ## CloudWatch ë©”íŠ¸ë¦­ í™•ì¸
	@echo "$(BLUE)ğŸ“Š ë©”íŠ¸ë¦­ ($(STAGE))$(NC)"
	npx serverless metrics --stage $(STAGE) --region $(REGION)

.PHONY: requirements
requirements: ## requirements.txt ì—…ë°ì´íŠ¸
	@echo "$(YELLOW)ğŸ“ requirements.txt ì—…ë°ì´íŠ¸ ì¤‘...$(NC)"
	. $(VENV)/bin/activate && pip freeze | grep -v pkg-resources > requirements-freeze.txt
	@echo "$(GREEN)âœ… requirements-freeze.txt ìƒì„± ì™„ë£Œ$(NC)"

# Docker ê´€ë ¨ ëª…ë ¹ì–´ ì œê±° (Serverless Framework ì‚¬ìš©)
# Dockerê°€ í•„ìš”í•œ ê²½ìš°:
# - serverless deploy --docker ì˜µì…˜ ì‚¬ìš©
# - Lambda Layer ë¹Œë“œ ì‹œ layers/build.sh ì‚¬ìš©

.PHONY: all
all: setup install validate ## ì „ì²´ ì„¤ì • ë° ê²€ì¦